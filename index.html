<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Thanksgiving ‚úàÔ∏è Airlift ‚Äî Word Games</title>
<style>
:root{--bg:#0f172a;--panel:#111827;--ink:#e5e7eb;--muted:#9ca3af;--accent:#f59e0b;--aviation:#38bdf8;--card:#0b1223}
*{box-sizing:border-box}html,body{margin:0;height:100%;background:linear-gradient(180deg,#0b1022,#0a1330)}
body{color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;display:flex;justify-content:center}
.wrap{width:100%;max-width:980px;padding:16px}
.app{background:var(--panel);border:1px solid #1f2937;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;background:linear-gradient(90deg,#0a142a,#0b1c3e)}
header h1{margin:0;font-size:18px;display:flex;gap:10px;align-items:center}
.badge{background:rgba(34,197,94,.18);color:#22c55e;padding:3px 8px;border-radius:999px;font-size:12px}
nav.tabs{display:flex;gap:8px}
nav.tabs button{background:#0c1630;border:1px solid #1f2b47;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
nav.tabs button.active{background:var(--aviation);border-color:var(--aviation);color:#00111b;font-weight:700}
.content{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;padding:16px}
@media (max-width:860px){.content{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid #1a2441;border-radius:16px;padding:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.kv{display:flex;gap:8px;align-items:center;font-variant-numeric:tabular-nums}
.kv strong{font-size:18px}
.hint{color:var(--muted);font-size:13px}
.grid{display:grid;gap:8px;user-select:none}
.grid.size-4{grid-template-columns:repeat(4,1fr)}
.grid.size-5{grid-template-columns:repeat(5,1fr)}
.tile{aspect-ratio:1/1;background:#101a34;border:1px solid #243150;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:800;cursor:pointer;position:relative;transition:transform .05s}
.tile:active{transform:scale(.98)}
.tile.sel{outline:2px solid var(--aviation);background:#0c213f}
.tile.blocked{outline:2px solid #7f1d1d;background:#3b0a0a}
.tile .sub{position:absolute;bottom:6px;right:8px;font-size:11px;color:#94a3b8}
.tile span{color:#fff !important;text-shadow:0 0 3px rgba(0,0,0,.6)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.btn{background:#0f1d3b;border:1px solid #23345a;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,#19a1e6,#1284c1);border-color:#1e6fa1;color:#001018;font-weight:700}
.btn.good{background:#0d3527;border-color:#146a4e;color:#9af0cf}
.btn.warn{background:#3a0f0f;border-color:#7a1f1f;color:#ffc3c3}
.wordbar{display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:wrap}
.wordbar .current{min-height:36px;display:flex;align-items:center;padding:8px 10px;background:#0b1733;border-radius:8px;border:1px solid #203053;font-weight:700}
.wordbar .current.bad{color:#fecaca;border-color:#7f1d1d}
.found{display:grid;gap:8px;max-height:360px;overflow:auto;padding-right:4px}
.found .item{display:flex;justify-content:space-between;gap:10px;padding:6px 8px;background:#0f1c37;border:1px solid #1e2b49;border-radius:10px}
.tag{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid #3a4c78;color:#9db6ff}
.tag.gold{border-color:#856200;color:#ffd77a;background:rgba(251,191,36,.08)}
.section-title{margin:0 0 8px 0;font-size:14px;color:#cbd5e1}
.divider{height:1px;background:#1c2746;margin:10px 0}
.score{font-size:28px;font-weight:800;color:#d1fae5}
.small{font-size:12px}.muted{color:#9ca3af}
.footer-note{padding:10px 16px;color:#a7b0c3;background:#0c142b;border-top:1px solid #1b2646;font-size:12px}
.pill{padding:6px 10px;border:1px solid #27314c;border-radius:999px;background:#0d1731}
</style>
</head>
<body>
<div class="wrap">
  <div class="app" role="application" aria-label="Airlift Word Games">
    <header>
      <h1><span id="packName">Thanksgiving ‚úàÔ∏è Airlift</span> <span class="badge">Daily</span></h1>
      <nav class="tabs" aria-label="Game modes">
        <button class="tab active" data-tab="grid" aria-pressed="true">Runway Rumble</button>
        <button class="tab" data-tab="anagram" aria-pressed="false">Luggage Tag Shuffle</button>
      </nav>
    </header>

    <div class="hint" style="text-align:center;margin:8px 16px 0;">
      <b>How to play:</b> Click/tap adjacent letters to form words (‚â• 3 letters). The board is built from the pack, so every round contains many valid aviation/holiday words. If a path isn‚Äôt leading to a word, selection won‚Äôt continue. Press <b>Start</b> or just click the board to auto-start. ‚úàÔ∏è/ü¶É words score √ó1.5.
    </div>

    <section id="grid" class="content">
      <div class="card">
        <div class="row">
          <div class="kv"><span class="hint">Puzzle</span> <strong id="puzzleId">‚Äî</strong></div>
          <div class="kv"><span class="hint">Timer</span> <strong id="timer">2:00</strong></div>
          <div class="kv"><span class="hint">Score</span> <strong class="score" id="score">0</strong></div>
          <div class="kv"><span class="hint">Words</span> <strong id="foundCount">0 / 0</strong></div>
          <label class="pill"><input type="checkbox" id="hard"> 5√ó5 Pro</label>
          <button class="btn" id="reshuffle" title="New daily seed">Reseed</button>
        </div>

        <div id="gridWrap" class="grid size-4" style="margin-top:12px"></div>

        <div class="wordbar">
          <div class="current" id="currentWord" aria-live="polite"></div>
          <button class="btn primary" id="submitWord">Submit</button>
          <button class="btn" id="backspace">Backspace</button>
          <button class="btn warn" id="clearSel">Clear</button>
        </div>

        <div class="controls">
          <button class="btn good" id="startBtn">Start (2:00)</button>
          <button class="btn" id="hintBtn">Hint</button>
          <span class="hint">Bonus √ó1.5 for ‚úàÔ∏è/ü¶É words.</span>
        </div>
      </div>

      <aside class="card">
        <h3 class="section-title">Found words</h3>
        <div id="foundList" class="found" aria-live="polite"></div>
        <div class="divider"></div>
        <h3 class="section-title">High scores</h3>
        <div class="row small"><span class="pill">Today:</span> <strong id="bestToday">0</strong></div>
        <div class="row small"><span class="pill">All-time:</span> <strong id="bestAll">0</strong></div>
      </aside>
    </section>

    <!-- Anagram mode kept simple -->
    <section id="anagram" class="content" hidden>
      <div class="card"><div class="small muted">Coming soon‚Äîunchanged for this update so we can focus on Runway Rumble.</div></div>
    </section>

    <div class="footer-note">
      Host this file and swap packs via <code>?pack=thanksgiving</code> or <code>?pack=christmas</code>, or hardcode a pack URL with <code>?packUrl=...</code>
    </div>
  </div>
</div>

<script>
/* ===================== Pack loader ===================== */
const urlParams = new URL(location.href).searchParams;
const packParam = urlParams.get('pack');
const packUrlParam = urlParams.get('packUrl');
const PACK_BASE = 'packs/';
let WORDPACK_URL = packUrlParam ? packUrlParam : PACK_BASE + (packParam || 'thanksgiving') + '.json';

let PACK=null;
async function loadWordPack(){
  try{
    const r = await fetch(WORDPACK_URL, {cache:'no-cache'});
    if(!r.ok) throw new Error(r.status);
    return await r.json();
  }catch(e){ console.error('Pack load failed', e); return null; }
}

/* ===================== Utilities ===================== */
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
function yyyymmddKey(d=new Date()){const dt=new Date(d.getFullYear(),d.getMonth(),d.getDate());return dt.toISOString().slice(0,10)}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;}}
function seededRngFrom(str){let h=2166136261>>>0;for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=Math.imul(h,16777619)}return mulberry32(h>>>0)}
function randChoice(rng,arr){return arr[Math.floor(rng()*arr.length)]}
function formatTime(sec){const m=Math.floor(sec/60),s=sec%60;return `${m}:${s.toString().padStart(2,'0')}`}

/* ===================== Trie (prefix guard) ===================== */
function buildTrie(words){
  const root=Object.create(null);
  for(const w of words){
    let node=root;
    for(const ch of w){
      node[node.key=ch] ??= Object.create(null);
      node=node[ch] ?? (node[ch]=Object.create(null));
    }
    node.$=1; // terminal
  }
  return root;
}
function trieHasPrefix(root, pref){
  let node=root;
  for(const ch of pref){
    node=node[ch]; if(!node) return false;
  }
  return true;
}
function trieHasWord(root, w){
  let node=root;
  for(const ch of w){ node=node[ch]; if(!node) return false; }
  return !!node.$;
}

/* ===================== Game state ===================== */
let gridSize=4, rng=seededRngFrom(yyyymmddKey()), tiles=[], letters=[], selection=[];
let running=false, timeLeft=120, timerId=null, score=0;
const todayKey=yyyymmddKey(); const LSKEY="tgx_airlift_scores2";
let allowedWords=[], allowedTrie=null;
let embeddedWords=[], embedTarget=0;

/* ===================== Build board from words ===================== */
function makeAllowedFromPack(pack){
  const core = (pack.grid?.core_words||[]).map(s=>String(s).toLowerCase());
  const golden = (pack.grid?.golden_words||[]).map(s=>String(s).toLowerCase());
  const iata = (pack.grid?.iata||[]).map(s=>String(s).toUpperCase());
  const all = new Set([...core, ...golden, ...iata.map(x=>x.toLowerCase())]
    .filter(w=>/^[a-z]{2,}$/i.test(w))); // letters only
  return { list:Array.from(all), golden:new Set(golden), iata:new Set(iata) };
}

// neighbors of cell index
function neighborsOf(i, N){
  const n=[]; const r=(i/N)|0, c=i%N;
  for(let dr=-1; dr<=1; dr++) for(let dc=-1; dc<=1; dc++){
    if(dr===0&&dc===0) continue;
    const rr=r+dr, cc=c+dc;
    if(rr>=0&&rr<N&&cc>=0&&cc<N) n.push(rr*N+cc);
  }
  return n;
}

// Try to lay a single word onto board (letters[]), overlapping if matching
function placeWordOnBoard(word, N){
  const W=word.toLowerCase(); const total=N*N;
  const tries=200; // plenty
  for(let t=0;t<tries;t++){
    const start = Math.floor(rng()*total);
    const path=[start];
    const placed = new Map(); // index -> letter we set in this attempt
    function dfs(pos, k){
      if(letters[pos] && letters[pos]!==W[k]) return false;
      if(!letters[pos]) placed.set(pos, W[k]); // tentatively place
      if(k===W.length-1) return true;
      const nbrs = neighborsOf(pos, N);
      // randomize neighbors
      for(let i=nbrs.length-1;i>0;i--){ const j=(Math.floor(rng()*(i+1))); [nbrs[i],nbrs[j]]=[nbrs[j],nbrs[i]]; }
      for(const n of nbrs){
        if(path.includes(n)) continue; // can‚Äôt reuse in same word
        path.push(n);
        if(dfs(n, k+1)) return true;
        path.pop();
      }
      return false;
    }
    if(dfs(start,0)){
      // commit placements
      for(const [idx,ch] of placed) letters[idx]=ch;
      return true;
    }else{
      // rollback tentative marks
      for(const [idx] of placed) if(letters[idx]===undefined) delete letters[idx];
    }
  }
  return false;
}

function buildBoardFromWords(pack){
  const N=gridSize;
  letters = new Array(N*N);
  const bag = (pack.grid?.letter_bag||[]).map(x=>String(x).toUpperCase());
  const { list, golden } = makeAllowedFromPack(pack);

  // target count (defaults or pack overrides)
  const min4 = Number(pack.grid?.min_embed_4x4 ?? 10);
  const min5 = Number(pack.grid?.min_embed_5x5 ?? 15);
  embedTarget = (N===5?min5:min4);

  // choose candidate words (prefer golden + 4‚Äì7 letters for nice paths)
  const candidates = list
    .filter(w=>w.length>=3 && w.length<=Math.min(7, N*N))
    .sort((a,b)=>{
      const ag=golden.has(a)?1:0, bg=golden.has(b)?1:0;
      if(ag!==bg) return bg-ag; // golden first
      return b.length-a.length; // longer first
    });

  embeddedWords = [];
  let guard=0;
  while(embeddedWords.length < embedTarget && guard++ < 400){
    const w = randChoice(rng, candidates);
    if(embeddedWords.includes(w)) continue;
    if(placeWordOnBoard(w, N)){
      embeddedWords.push(w);
    }
  }

  // fill remaining empty cells from bag or A‚ÄìZ fallback
  for(let i=0;i<letters.length;i++){
    if(!letters[i]){
      const ch = bag.length ? randChoice(rng, bag).toUpperCase() :
        String.fromCharCode(65+Math.floor(rng()*26));
      letters[i]=ch.toLowerCase();
    }
  }
}

/* ===================== UI wiring ===================== */
function renderGrid(){
  const wrap=$('#gridWrap'); wrap.innerHTML='';
  wrap.classList.toggle('size-5', gridSize===5);
  wrap.classList.toggle('size-4', gridSize===4);
  tiles = [];
  for(let i=0;i<letters.length;i++){
    const t=document.createElement('button');
    t.className='tile';
    t.dataset.index=i;
    t.dataset.letter=letters[i];
    t.innerHTML=`<span>${letters[i].toUpperCase()}</span><span class="sub">${i+1}</span>`;
    t.addEventListener('click',()=>tap(i));
    tiles.push(t); wrap.appendChild(t);
  }
  $('#foundCount').textContent=`0 / ${embeddedWords.length}`;
  $('#puzzleId').textContent=yyyymmddKey().replaceAll('-','');
  updateCurrentWord(true);
}

// prefix guard: extend only if next letter keeps a valid prefix
function tap(i){
  if(!running) startTimer(); // auto start
  if(selection.includes(i)) return; // no repeat in same word
  const next = (currentWord()+tiles[i].dataset.letter);
  if(!trieHasPrefix(allowedTrie, next)){
    // if no prefix, allow only if empty (first click) and next alone is a prefix
    if(currentWord().length!==0) { flashBad(); return; }
    if(!trieHasPrefix(allowedTrie, tiles[i].dataset.letter)) { flashBadTile(i); return; }
  }
  // adjacency rule
  if(selection.length){
    const last = selection[selection.length-1];
    if(!neighborsOf(last,gridSize).includes(i)){ flashBadTile(i); return; }
  }
  selection.push(i); tiles[i].classList.add('sel'); updateCurrentWord();
}

function backspace(){
  const i=selection.pop(); if(i!=null) tiles[i].classList.remove('sel');
  updateCurrentWord();
}
function clearSel(){ for(const i of selection) tiles[i].classList.remove('sel'); selection=[]; updateCurrentWord(true) }
function currentWord(){ return selection.map(i=>tiles[i].dataset.letter).join('') }
function updateCurrentWord(clearBad=false){
  const el=$('#currentWord');
  el.textContent=currentWord().toUpperCase();
  if(clearBad) el.classList.remove('bad');
}

function flashBad(){ const el=$('#currentWord'); el.classList.add('bad'); setTimeout(()=>el.classList.remove('bad'),350); }
function flashBadTile(i){ tiles[i].classList.add('blocked'); setTimeout(()=>tiles[i].classList.remove('blocked'),250); }

function wordScore(w, packGolden, packIata){
  let pts=w.length;
  if(w.length>=5) pts+=2;
  if(packGolden.has(w)||packIata.has(w.toUpperCase())) pts = Math.round(pts*1.5);
  return pts;
}

let found=new Set();
function renderFound(packGolden, packIata){
  const box=$('#foundList'); box.innerHTML='';
  const items=Array.from(found).sort((a,b)=>b.length-a.length||a.localeCompare(b));
  for(const w of items){
    const row=document.createElement('div'); row.className='item';
    const gold = packGolden.has(w)||packIata.has(w.toUpperCase());
    row.innerHTML=`<span>${w.toUpperCase()}</span><span class="tag ${gold?'gold':''}">${wordScore(w,packGolden,packIata)} pts</span>`;
    box.appendChild(row);
  }
  $('#foundCount').textContent=`${found.size} / ${embeddedWords.length}`;
}

/* ===================== Timer / scores ===================== */
function startTimer(){ if(running) return; running=true; timeLeft=120; $('#startBtn').disabled=true; tick(); }
function tick(){
  $('#timer').textContent=formatTime(timeLeft);
  if(timeLeft<=0){ running=false; $('#startBtn').disabled=false; saveBest(); return; }
  timeLeft--; timerId=setTimeout(tick,1000);
}
function loadBest(){ try{return JSON.parse(localStorage.getItem(LSKEY)||"{}")}catch{ return {} } }
function saveBest(){
  const o=loadBest();
  o.bestAll=Math.max(o.bestAll||0, score);
  o.byDay=o.byDay||{}; o.byDay[todayKey]=Math.max(o.byDay[todayKey]||0, score);
  localStorage.setItem(LSKEY, JSON.stringify(o));
  $('#bestAll').textContent=o.bestAll||0;
  $('#bestToday').textContent=o.byDay?.[todayKey]||0;
}

/* ===================== Submit / Hint ===================== */
function submitCurrent(packGolden, packIata){
  if(!selection.length) return;
  const w=currentWord();
  if(!trieHasWord(allowedTrie, w)){ flashBad(); clearSel(); return; }
  // Also confirm path exists (it does, we just walked it), so score:
  if(found.has(w)){ clearSel(); return; }
  found.add(w);
  score += wordScore(w,packGolden,packIata);
  $('#score').textContent=score;
  renderFound(packGolden, packIata);
  clearSel();
}
function hint(){
  // pick from embedded words not yet found, shortest first
  const remaining = embeddedWords.filter(w=>!found.has(w));
  const pick = remaining.sort((a,b)=>a.length-b.length || a.localeCompare(b))[0] || 'ANY AVIATION WORD';
  const el=document.createElement('div'); el.className='small muted';
  el.textContent=`Try to find: ${pick.toUpperCase()}`;
  const slot=$('#foundList').parentElement; slot.insertBefore(el, slot.firstChild);
  setTimeout(()=>el.remove(), 3000);
}

/* ===================== Init / reseed ===================== */
async function initGridMode(){
  // load pack if needed
  if(!PACK) PACK = await loadWordPack();
  const metaName = PACK?.meta?.name; if(metaName) $('#packName').textContent = metaName;

  // timers from pack (optional)
  const gridTimer = Number(PACK?.settings?.gridTimerSec||120); timeLeft=gridTimer;

  // allowed words + trie
  const { list, golden, iata } = makeAllowedFromPack(PACK);
  allowedWords = list;
  allowedTrie = buildTrie(allowedWords);

  // build board by embedding words
  buildBoardFromWords(PACK);
  renderGrid();

  // reset round vars
  running=false; score=0; found.clear();
  $('#score').textContent=score;
  $('#timer').textContent=formatTime(gridTimer);
  $('#bestAll').textContent=loadBest().bestAll||0;
  $('#bestToday').textContent=loadBest().byDay?.[todayKey]||0;

  // bind once with closures over pack sets
  $('#submitWord').onclick=()=>submitCurrent(golden,iata);
  $('#backspace').onclick=backspace;
  $('#clearSel').onclick=clearSel;
  $('#startBtn').onclick=startTimer;
  $('#hintBtn').onclick=hint;
}

function reseed(){
  rng = seededRngFrom(yyyymmddKey()+Math.random());
  initGridMode();
}

document.addEventListener('keydown',(e)=>{
  if(e.key==='Enter') $('#submitWord').click();
  else if(e.key==='Backspace'){ e.preventDefault(); backspace(); }
  else if(e.key==='Escape') clearSel();
});

/* UI toggles */
$('#hard').addEventListener('change',()=>{ gridSize=$('#hard').checked?5:4; initGridMode(); });
$('#reshuffle').addEventListener('click',reseed);

/* Boot */
initGridMode();
</script>
</body>
</html>
